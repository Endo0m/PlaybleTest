import { _decorator, Component, Node } from 'cc';
import { HealthSystem } from '../Systems/HealthSystem';
import { GameEvents } from '../../Core/Events/GameEvents';

const { ccclass, property } = _decorator;

@ccclass('PlayerInvulnerability')
export class PlayerInvulnerability extends Component {
    @property({ type: Node })
    public playerNode: Node | null = null;

    @property
    public invulnerabilityDuration: number = 1.0;

    @property
    public blinkInterval: number = 0.1;

    private isInvulnerable: boolean = false;
    private invulnerabilityTimer: number = 0;
    private blinkTimer: number = 0;
    private healthSystem: HealthSystem | null = null;

    public initialize(healthSystem: HealthSystem): void {
        this.healthSystem = healthSystem;
    }

    public onDestroy(): void {
    }

    public update(deltaTime: number): void {
        if (!this.isInvulnerable) {
            return;
        }

        this.invulnerabilityTimer -= deltaTime;
        this.blinkTimer -= deltaTime;

        if (this.blinkTimer <= 0) {
            this.blinkTimer = this.blinkInterval;
            this.toggleVisibility();
        }

        if (this.invulnerabilityTimer <= 0) {
            this.endInvulnerability();
        }
    }

    public isInvulnerableNow(): boolean {
        return this.isInvulnerable;
    }

    public startInvulnerability(): void {
        if (this.healthSystem) {
            this.healthSystem.takeDamage(1);
        }

        this.isInvulnerable = true;
        this.invulnerabilityTimer = this.invulnerabilityDuration;
        this.blinkTimer = this.blinkInterval;
    }

    private endInvulnerability(): void {
        this.isInvulnerable = false;
        this.setVisibility(true);
    }

    private toggleVisibility(): void {
        const node = this.playerNode || this.node;
        node.active = !node.active;
    }

    private setVisibility(visible: boolean): void {
        const node = this.playerNode || this.node;
        node.active = visible;
    }
}

